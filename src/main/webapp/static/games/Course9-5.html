
<body>
<header class="am-topbar am-topbar-inverse">
	<!-- 引入个人blockly -->

  <script src="myblock/lr_blocks.js"></script>
  <script src="assets/js/wait_block.js"></script>
  <h1 class="am-topbar-brand">
    <a href="HomePage.html" class="am-icon-home am-icon-lg">课程9:蜜蜂：计数循环</a>
  </h1>

  <button class="am-topbar-btn am-topbar-toggle am-btn am-btn-sm am-btn-success am-show-sm-only"
          data-am-collapse="{target: '#doc-topbar-collapse'}"><span class="am-sr-only">导航切换</span> <span
          class="am-icon-bars"></span></button>

  <div class="am-collapse am-topbar-collapse" id="doc-topbar-collapse">
    <div class="am-btn-group am-topbar-center">
      <a href="./getCheckpoint?level=9-1" type="button" class="am-btn am-btn-primary am-round">1</a>
      <a href="./getCheckpoint?level=9-2" type="button" class="am-btn am-btn-primary am-round">2</a>
      <a href="./getCheckpoint?level=9-3" type="button" class="am-btn am-btn-primary am-round">3</a>
      <a href="./getCheckpoint?level=9-4" type="button" class="am-btn am-btn-primary am-round">4</a>
      <a href="./getCheckpoint?level=9-5" type="button" class="am-btn am-btn-primary am-round am-active">5</a>
      <a href="./getCheckpoint?level=9-6" type="button" class="am-btn am-btn-primary am-round">6</a>
      <a href="./getCheckpoint?level=9-7" type="button" class="am-btn am-btn-primary am-round">7</a>
      <a href="./getCheckpoint?level=9-8" type="button" class="am-btn am-btn-primary am-round">8</a>
      <a href="./getCheckpoint?level=9-9" type="button" class="am-btn am-btn-primary am-round">9</a>
      <a href="./getCheckpoint?level=9-10" type="button" class="am-btn am-btn-primary am-round">10</a>
      <a href="./getCheckpoint?level=9-11" type="button" class="am-btn am-btn-primary am-round">11</a>
    </div>
    <button class="am-btn am-btn-primary">更多
      <i class="am-icon-chevron-circle-down"></i>
    </button>
    <div class="am-topbar-right">
      <div class="am-dropdown" data-am-dropdown="{boundary: '.am-topbar'}">
        <button class="am-btn am-btn-primary am-topbar-btn am-btn-sm">登录</button>
        <button data-am-dropdown-toggle class="am-btn am-btn-secondary am-topbar-btn am-btn-sm am-dropdown-toggle">
          <i class="am-icon-bars"></i>
        </button>
        <ul class="am-dropdown-content">
          <li><a href="#">注册</a></li>
          <li><a href="#">随便看看</a></li>
        </ul>
      </div>
    </div>


  </div>
</header>

<!--在这里编写你的代码-->

<div class="am-g doc-am-g">    
  <div class="am-u-sm-18 am-u-lg-4">
    <div id="bediv" style="width:400px; height:400px;background:url(pictures/nine/course9-5.jpg) no-repeat">

      <div style="padding-left:150px;padding-top:5px">
        <img id="be" src="pictures/nine/be.jpg" class="am-circle am-img-responsive am-img-xs" alt="beimg">
           <div style="left: 210px;position: absolute;top: 80px;color:#FFFFFF"><p><span id="flower1">1</span></p></div>
           <div style="left: 210px;position: absolute;top: 180px;color:#FFFFFF"><p><span id="flower2">2</span></p></div>
           <div style="left: 210px;position: absolute;top: 330px;color:#FFFFFF"><p><span id="flower3">3</span></p></div>
        
      </div>
    </div>
    <div class="am-g" style="width:430px;">
      <div class="am-u-sm-6">
        <button type="button" id="runButton" class="am-btn am-btn-primary am-radius am-btn-xl am-fl" onclick="runCode()">
          <i class="am-icon-play"></i>
          运行</button>
      </div>
      <div class="am-u-sm-6">
        <button type="button" class="am-btn am-btn-primary am-radius am-btn-xl am-fr " onclick="stepCode()">
          <i class="am-icon-forward"></i>步进</button>
      </div>
    </div>
  </div>
  <div  id="blocklyArea" class="am-u-sm-12 am-u-lg-8 am-u-end" style="background-color:LightSteelBlue">
    <div class="am-container">
      <img id="be2" src="pictures/nine/be.jpg" class="am-circle am-fl">
      <p class="am-center">现在我们需要往前移动“计数器”这么多次，然后收集“计数器”这么多次花蜜。你能用两个重复循环来解决这个挑战吗？</p>
    </div>
    <div class="am-g" style="background-color:SteelBlue">
      <div class="am-u-sm-4 am-u-md-2 am-u-lg-2">
        模块
      </div>
      <div class="am-u-sm-4 am-u-md-6 am-u-lg-4">
        工作区域1/6模块
      </div>
      <div class="am-u-sm-4 am-u-md-4 am-u-lg-6">
        <button type="button" class="am-btn am-btn-primary am-radius am-btn-sm am-fr" onclick="restart()">
          <i class="am-icon-refresh"></i>
          重新开始
        </button>
        <button type="button" class="am-btn am-btn-primary am-radius am-btn-sm am-fr" onclick="generateCode()">
          <i class="am-icon-play-circle"></i>
          显示代码
        </button>
      </div>
    </div>
    <!--  blockly工作区<!-->
    <div id="blocklyDiv" style="height: 400px; "></div>
  </div>
</div>


<xml xmlns="http://www.w3.org/1999/xhtml" id="workspaceBlocks" style="display:none">
  <block type="start_block"></block>
</xml>
<xml xmlns="http://www.w3.org/1999/xhtml" id="toolbox" style="display: none;">
  <block type="move"></block>

  <block type="controls_for">
        <field name="VAR">i</field>
        <value name="FROM">
          <block type="math_number">
            <field name="NUM">1</field>
          </block>
        </value>
        <value name="TO">
          <block type="math_number">
            <field name="NUM">???</field>
          </block>
        </value>
        <value name="BY">
          <block type="math_number">
            <field name="NUM">1</field>
          </block>
        </value>
      </block>
  
  <block type="lr_gatherhoney"></block>
  <block type="controls_repeat_ext"></block>
  <block type="variables_get">
    <field name="VAR">i</field>
  </block>
  <block type="wait_seconds" id="wait">
        <field name="SECONDS">1.0</field>
      </block>
</xml>

<div class="am-modal am-modal-confirm" tabindex="-1" id="success-confirm">
  <div class="am-modal-dialog">
    <div class="am-modal-hd">Amaze UI</div>
    <div class="am-modal-bd">
      祝贺你，完成了关卡1！
    </div>
    <div class="am-modal-footer">
      <span class="am-modal-btn" data-am-modal-cancel>取消</span>
      <span class="am-modal-btn" data-am-modal-confirm>下一关</span>
    </div>
  </div>
</div>

<div class="am-modal am-modal-confirm" tabindex="-1" id="failed-confirm">
  <div class="am-modal-dialog">
    <div class="am-modal-hd">Amaze UI</div>
    <div class="am-modal-bd">
      还有一些问题没有解决。
    </div>
    <div class="am-modal-footer">
      <span class="am-modal-btn" data-am-modal-cancel>取消</span>
      <span class="am-modal-btn" data-am-modal-confirm>重新开始</span>
    </div>
  </div>
</div>
<div id="output"></div>

<script type="text/javascript" src="myblock/workspace.js"></script>


<script>
var bemap = document.getElementById('bediv');   //地图，用以计算相对位置
var beimg = document.getElementById('be');
var count = 0;  //用以对块计数判断
var be_location = 0;  //判断蜜蜂是否移动到指定位置
var flower1=1;
var flower2=2;
var flower3=3;

/*function runCode() {
    // Generate JavaScript code and run it.
    window.LoopTrap = 1000;
    Blockly.JavaScript.INFINITE_LOOP_TRAP =
        'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';
    var code = Blockly.JavaScript.workspaceToCode(workspace);
    Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
    try {
        //code = code;
        alert(code);
        count = code.split(";").length - 1;
        eval(code);
        isRightResult();
    } catch (e) {
        alert(e);
    }
}*/

function restart() {
    location.reload();
}

//run the code,control the direction and move
var dire = 0;

var move = function () {
	be_location = be_location+1;

    var stepsum = 50;
    if (dire == 1) {
        $('#be').animate({
            marginLeft: "+=" + stepsum + "px"
        }, 500);
    } else if (dire == 0) {
        $('#be').animate({
            marginTop: "+=" + stepsum + "px"
        }, 500);
    } else if (dire == 2) {
        $('#be').animate({
            marginLeft: "-=" + stepsum + "px"
            
        }, 500);
        
    }
    //should try is the be is the right place
    //避开tnt的判断
    if (true) {

    }

    count = count - 1;
}

function turnleft() {
    document.getElementById('bediv');
    dire += 1;
    dire %= 4;
    $('#be').rotate(-90 * dire);
    count = count - 1;
}

function turnright() {
    document.getElementById('bediv');
    dire -= 1;
    dire %= 4;
    $('#be').rotate(90 * dire);
    count = count - 1;
}

function lr_gatherhoney(){

    if(be_location>=6){
      document.getElementById("flower3").innerHTML=flower3-1;
      flower3=flower3-1;
    }
    else if(be_location>=3){
      document.getElementById("flower2").innerHTML=flower2-1;
      flower2=flower2-1;
    }
    else if(be_location>=1){
   
    	document.getElementById("flower1").innerHTML=flower1-1;
    	flower1=flower1-1;

    }
    
    count = count - 1;

}

//判断是否是正确的结果
function isRightResult() {
    //isRightResult作为检查正确位置的激活
    var c=1;
    setInterval(function () {
        if (!$('#be').is(":animated") && c === 1) {
            var marginleft = beimg.offsetLeft - bemap.offsetLeft;
            var margintop = beimg.offsetTop - bemap.offsetTop;
            
            if (marginleft === 150 && margintop === 305&& flower1===0 &&flower2===0 &&flower3===0){
                //run success
            $('#success-confirm').modal({
                relatedTarget: this,
                onConfirm: function () {
                    window.location.replace("./getCheckpoint?level=9-6");
                },
                onCancel: function () {

                }
            });

            } else {
                //run failed
                //alert(marginleft + "," + margintop);
                $('#failed-confirm').modal({
                    relatedTarget: this,
                    onConfirm: function () {
                        restart();
                    },
                    onCancel: function () {

                    }
                });
            }
            c = c - 1;
        }
    }, 100);
}


//以下为运用js解释器实现的步进功能
//此处往下是通过javascript解释器实现的步进功能
    Blockly.JavaScript.addReservedWords('exit');
    var outputArea = document.getElementById('output');
    var stepButton = document.getElementById('stepButton');
    var runButton = document.getElementById('runButton');
    var myInterpreter = null;
    var runner;

    function initApi(interpreter, scope) {
      // Add an API function for the alert() block, generated for "text_print" blocks.
      interpreter.setProperty(scope, 'move',
          interpreter.createNativeFunction(function(text,number) {
        text = text ? text.toString() : '';
        
        //alert(number);
        move(text,number);
      }));


      var wrapper = interpreter.createAsyncFunction(
    function(timeInSeconds, callback) {
      // Delay the call to the callback.
      //alert(callback);
      setTimeout(callback, timeInSeconds * 300);
    });
  interpreter.setProperty(scope, 'waitForSeconds', wrapper);

      // Add an API function for the prompt() block.
      var wrapper = function(text) {
        text = text ? text.toString() : '';
        return interpreter.createPrimitive(prompt(text));
      };

      interpreter.setProperty(scope, 'lr_gatherhoney',
          interpreter.createNativeFunction(function(text,number) {
        text = text ? text.toString() : '';
       // angle = angle?angle.toString():' ';
        //alert(number);
        lr_gatherhoney(text,number);
      }));

      // Add an API function for highlighting blocks.
      var wrapper = function(id) {
        id = id ? id.toString() : '';
        return interpreter.createPrimitive(highlightBlock(id));
      };
      interpreter.setProperty(scope, 'highlightBlock',
          interpreter.createNativeFunction(wrapper));
    }

    var highlightPause = false;
    var latestCode = '';

    function highlightBlock(id) {
      workspace.highlightBlock(id);
      highlightPause = true;
    }

    function resetStepUi(clearOutput) {
      workspace.highlightBlock(null);
      highlightPause = false;
      runButton.disabled = '';

      if (clearOutput) {
        outputArea.value = 'Program output:\n=================';
      }
    }

    function generateCodeAndLoadIntoInterpreter() {
      // Generate JavaScript code and parse it.

      Blockly.JavaScript.STATEMENT_PREFIX = 'highlightBlock(%1);\n';
      Blockly.JavaScript.addReservedWords('highlightBlock');
      latestCode = Blockly.JavaScript.workspaceToCode(workspace);
      //alert(latestCode);
      resetStepUi(true);
    }

    function resetInterpreter() {
      myInterpreter = null;
      if (runner) {
        clearTimeout(runner);
        runner = null;
      }
    }

    function runCode() {
      if (!myInterpreter) {
        // First statement of this code.
        // Clear the program output.
        resetStepUi(true);
        runButton.disabled = 'disabled';

        // And then show generated code in an alert.
        // In a timeout to allow the outputArea.value to reset first.
        setTimeout(function() {
          alert('Ready to execute the following code\n' +
            '===================================\n' +
            latestCode);

          // Begin execution
          highlightPause = false;
          myInterpreter = new Interpreter(latestCode, initApi);
          runner = function() {
            if (myInterpreter) {
              var hasMore = myInterpreter.run();
              if (hasMore) {
                // Execution is currently blocked by some async call.
                // Try again later.
                setTimeout(runner, 1000);
              } else {
                // Program is complete.
               // outputArea.value += '\n\n<< Program complete >>';
               isRightResult();
                resetInterpreter();
                resetStepUi(false);
              }
            }
          };
          runner();
        }, 1);
        // isRightResult();
        return;
      }

    }


    function stepCode() {

      if (!myInterpreter) {
        // First statement of this code.
        // Clear the program output.
        resetStepUi(true);
        myInterpreter = new Interpreter(latestCode, initApi);

        // And then show generated code in an alert.
        // In a timeout to allow the outputArea.value to reset first.
        setTimeout(function() {
         // alert('Ready to execute the following code\n' + '===================================\n' + latestCode);
          highlightPause = true;
          stepCode();
        }, 1);
        return;
      }
      highlightPause = false;
      do {
        try {
          var hasMoreCode = myInterpreter.step();
          
            var c=1;
           setInterval(function () {
            if (!$('#be').is(":animated") && c === 1) {
            var marginleft = beimg.offsetLeft - bemap.offsetLeft;
            var margintop = beimg.offsetTop - bemap.offsetTop;
            
            if (marginleft === 150 && margintop === 305&& flower1===0 &&flower2===0 &&flower3===0){
                //run success
            $('#success-confirm').modal({
                relatedTarget: this,
                onConfirm: function () {
                    window.location.replace("./getCheckpoint?level=9-6");
                },
                onCancel: function () {

                }
            });

            } 
            c = c - 1;
        }
    }, 100);



        } finally {
          if (!hasMoreCode) {
            // Program complete, no more code to execute.

            myInterpreter = null;
            resetStepUi(false);

            // Cool down, to discourage accidentally restarting the program.
            stepButton.disabled = 'disabled';
            setTimeout(function() {
              stepButton.disabled = '';
            }, 2000);

            return;
          }
        }
        // Keep executing until a highlight statement is reached,
        // or the code completes or errors.
      } while (hasMoreCode && !highlightPause);
    }

    // Load the interpreter now, and upon future changes.
    generateCodeAndLoadIntoInterpreter();
    workspace.addChangeListener(function(event) {
      if (!(event instanceof Blockly.Events.Ui)) {
        // Something changed. Parser needs to be reloaded.
        resetInterpreter();
        generateCodeAndLoadIntoInterpreter();
      }
    });


</script>
<script>
    $(document).ready(function () {
        var rotate = function () {
            $("#be2").rotate({
                angle: 0,
                animateTo: 360,
                duration: 5000,
                callback: rotate,
                easing: function (x, t, b, c, d) {
                    return c * (t / d) + b;
                },
                bind: {
                    click: function () {
                        $(this).stopRotate();
                    }
                }
            });
        }
        rotate();
    });
</script>


<!-- 单步
  
<script type="text/javascript" src="myblock/acorn_interpreter.js"></script>
<script type="text/javascript" src="myblock/wait_block.js"></script>
<script type="text/javascript" src="myblock/step-execution.js"></script> -->
</body>
</html>